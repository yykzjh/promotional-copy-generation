# 营销文案生成 AI Agent - 设计方案

## 1. 架构概览

### 1.1 LLM 能力

采用多模态 LLM，主要支持两种调用模式：

- **文本+图像（可选，可能多张）→ 文本**：上下文增强、图像描述提示词生成、是否生成图像决策
- **文本+图像（可选，可能多张）→ 图像**：配图生成

### 1.2 整体架构

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         FastAPI 入口层                                    │
│  POST /generate  │  GET /health                                          │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    输入安全校验                                           │
│  校验：需求、描述、图片合规  │  失败 → 拒绝                                 │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    LangGraph Agent 编排层（4 个核心节点）                   │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ 上下文增强   │→ │ 是否生成图  │→ │ 文案撰写    │  │ 图片提示词   │   │
│  │ 文本+图→文  │  │ 动态决策    │  │ 增强→文案   │  │ 文本+图→文  │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └──────┬──────┘   │
│         │                  │                  │                  │      │
│         ▼                  ▼                  ▼                  ▼      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐   │
│  │ 图片生成    │  │ 有图通常出  │  │ Skills      │  │ 提示词+图   │   │
│  │ 文+图→图    │  │ 无图则LLM判│  │ (文案/平台)  │  │ →生成配图   │   │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘   │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    输出安全校验                                           │
│  校验：文案、图片提示词、生成图片  │  失败 → 拦截/重试                       │
└─────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    本地模型层（全部本地部署）                               │
│  vLLM 部署的主 LLM、多模态 LLM  │  图像生成 API（可选）                     │
└─────────────────────────────────────────────────────────────────────────┘
```

### 1.3 设计原则

- **图编排**：使用 LangGraph StateGraph 显式定义流程，支持条件分支
- **状态驱动**：节点间传递统一 State
- **模块化可扩展**：Skills、阶段上下文采用注册表/配置驱动
- **动态图像决策**：有输入图通常出图，除非用户明确/暗示仅要纯文本；无图则由 LLM 根据需求判断
- **安全优先**：输入与输出均经合规校验
- **本地优先**：所有模型本地部署；不调用外部 API

---

## 2. 状态设计

### 2.1 AgentState 定义

```python
from typing import TypedDict, Annotated
from langgraph.graph.message import add_messages

class AgentState(TypedDict, total=False):
    # 输入
    raw_requirements: str           # 原始营销需求
    raw_description: str            # 原始描述
    input_images: list[bytes]       # 输入图片（可选，可能多张）
    platform: str                   # 目标平台
    style: str                      # 风格偏好

    # 中间结果
    enhanced_context: str           # 上下文增强后的描述
    copy_draft: str                 # 文案草稿
    image_prompts: list[str]        # 图像描述提示词

    # 输出
    final_copy: str                 # 最终营销文案
    generated_images: list[bytes]   # 生成配图

    # 控制
    has_input_images: bool          # 是否有输入图片
    need_image_generation: bool     # 是否生成图像（动态决策结果）
    messages: Annotated[list, add_messages]

    # 安全校验
    input_safety_passed: bool
    output_safety_passed: bool
    safety_reject_reason: str
```

### 2.2 条件路由逻辑

| 条件 | 路由目标 |
|------|----------|
| 输入安全校验失败 | → 直接 END，返回错误 |
| 上下文增强 | → 始终执行 |
| 是否生成图像 | 有输入图通常生成，除非用户明确/暗示仅要纯文本；无图由 LLM 判断 |
| need_image_generation=True | → 图片提示词生成 → 图片生成节点 |
| 输出安全校验失败 | → 重试生成或返回安全提示 |

---

## 3. 节点设计

### 3.0 安全校验节点

#### 3.0.1 输入安全校验（InputSafetyChecker）

- **位置**：主流程入口
- **输入**：raw_requirements, raw_description, input_images
- **逻辑**：规则 + LLM 双重校验
- **不合规**：直接返回 400，不进入 Agent

#### 3.0.2 输出安全校验（OutputSafetyChecker）

- **位置**：主流程出口
- **输入**：final_copy, image_prompts, generated_images
- **逻辑**：对生成内容进行规则 + LLM 双重校验

### 3.1 上下文增强节点（ContextEnhancer）

- **输入**：raw_requirements, raw_description, input_images（可选，可能多张）
- **模态**：文本+图像（可选）→ 文本
- **逻辑**：单次 LLM 调用同时输出增强提示词与是否生成图像决策；有图时通常为 True，除非用户明确/暗示仅要纯文本
- **输出**：enhanced_context, need_image_generation

### 3.2 文案生成节点（CopyWriter）

- **输入**：enhanced_context（来自 context_enhancer）, platform, style
- **模态**：文本 → 文本
- **逻辑**：将增强后的提示词生成推广文案文本
- **工具**：Skills（文案规范、平台规范）
- **输出**：final_copy

### 3.3 图像描述提示词节点（ImagePromptGenerator）

- **输入**：raw_requirements, raw_description, enhanced_context, input_images（可选，可能多张）
- **模态**：文本+图像（可选）→ 文本
- **逻辑**：根据需求与可选输入图生成图像描述提示词
- **输出**：image_prompts（1–3 条）

### 3.4 图片生成节点（ImageGenerator）

- **输入**：image_prompts, input_images（可选，可能多张）
- **模态**：文本+图像（可选）→ 图像
- **逻辑**：图像描述提示词 + 可选输入图 → 生成推广文案配图
- **配置**：IMAGE_GEN_ENABLED 启用
- **输出**：generated_images

---

## 4. 图结构

### 4.1 主流程

```
                    ┌──────────────┐
                    │    START     │
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │ InputSafety  │ ── 失败 ──→ END (400)
                    └──────┬───────┘
                           │ 通过
                           ▼
                    ┌──────────────┐
                    │ ContextEnh   │  文本+图(可选)→增强+need_image
                    └──────┬───────┘
                           │
                           ▼
                    ┌──────────────┐
                    │  CopyWriter  │  增强提示词→推广文案
                    └──────┬───────┘
                           │
              ┌────────────┴────────────┐
              │ need_image_generation?  │
              └────────────┬────────────┘
                    │              │
                   Yes             No
                    │              │
                    ▼              │
             ┌─────────────┐       │
             │ImagePrompt  │       │  文本+图(可选)→图像提示词
             └──────┬──────┘       │
                    │              │
                    ▼              │
             ┌─────────────┐       │
             │ ImageGen    │       │  提示词+图(可选)→配图
             └──────┬──────┘       │
                    │              │
                    └──────┬───────┘
                           ▼
                    ┌──────────────┐
                    │OutputSafety  │ ── 失败 ──→ 重试/拦截
                    └──────┬───────┘
                           │ 通过
                           ▼
                    ┌──────────────┐
                    │     END      │
                    └──────────────┘
```

### 4.2 执行顺序

- **串行**：input_safety → context_enhance → need_image_decision → copy_write
- **条件分支**：need_image_generation=True 时，copy_write 后执行 image_prompt → image_gen
- **出口**：output_safety → END

---

## 5. 模块化与扩展设计

### 5.1 设计目标

- **Skills**：按阶段注册，支持热加载；新增 Skill 通过添加文件并注册
- **阶段上下文**：各阶段有独立上下文配置；可扩展字段与来源
- **MCP Servers**：配置驱动，按需加载；新增 MCP 通过编辑配置
- **统一扩展点**：注册表模式；所有扩展组件遵循同一注册规范

### 5.2 Skills 模块化

#### 5.2.1 注册机制

```python
# promotional_copy_generation/skills/registry.py

from typing import Protocol
from pathlib import Path

class Skill(Protocol):
    """Skill 协议：所有 Skill 必须实现"""
    id: str
    name: str
    stage: str          # context_enhance | need_image_decision | copy_write | image_prompt
    description: str
    content: str        # Markdown 或结构化内容

def load_skill(path: Path) -> Skill: ...
def get_skills_for_stage(stage: str) -> list[Skill]: ...
def register_skill(skill: Skill) -> None: ...
```

#### 5.2.2 目录与加载

```
promotional_copy_generation/skills/
├── registry.py           # 注册与加载逻辑
├── loader.py             # 从文件/目录自动发现 Skill
└── builtin/              # 内置 Skills（可扩展）
    ├── copy_writing/
    │   └── SKILL.md      # 文案撰写
    ├── platform_rules/
    │   ├── xiaohongshu.md
    │   ├── weibo.md
    │   └── douyin.md
    └── image_prompt/
        └── SKILL.md      # 图片提示词
```

#### 5.2.3 扩展方式

- **内置扩展**：在 `builtin/` 下新增目录，放置 `SKILL.md` 或 `config.yaml + content.md`
- **外部扩展**：通过 `SKILLS_DIRS` 配置指定额外目录；loader 自动扫描
- **阶段绑定**：Skill 的 `stage` 字段决定注入到哪个节点

### 5.3 阶段专属上下文

#### 5.3.1 阶段-上下文映射

| 阶段 | 上下文键 | 来源 | 用途 |
|------|----------|------|------|
| context_enhance | `prompt_template` | 配置 | 增强+是否生成图像（单次 LLM） |
| copy_write | `copy_skills` | Skills | 文案规范、平台规范 |
| image_prompt | `prompt_skills` | Skills | 图片提示词规范 |
| image_prompt | `negative_prompt` | 配置 | 负向提示词模板 |

#### 5.3.2 上下文配置结构

```yaml
# config/stage_contexts.yaml

stages:
  context_enhance:
    prompt_template: "prompts/context_enhance.txt"
    skills: []

  copy_write:
    prompt_template: "prompts/copy_write.txt"
    skills: ["copy_writing", "platform_rules"]

  image_prompt:
    prompt_template: "prompts/image_prompt.txt"
    skills: ["image_prompt"]
    negative_prompt: "ugly, blurry, low quality"
```

#### 5.3.3 扩展方式

- **新增阶段**：在配置中新增 `stages.<new_stage>`；在图中新增对应节点
- **修改上下文**：编辑 `stage_contexts.yaml` 或对应 Skill 文件
- **动态注入**：节点通过 StageContextLoader 按 `state.platform`、`state.style` 等获取上下文

### 5.4 扩展点汇总

| 扩展类型 | 配置/注册位置 | 扩展方式 |
|----------|---------------|----------|
| Skill | `skills/builtin/` 或 `SKILLS_DIRS` | 新增目录 + SKILL.md |
| 阶段上下文 | `config/stage_contexts.yaml` | 编辑 YAML 或新增阶段 |
| 安全规则 | `safety/rules/` | 新增违禁词文件、规则文件 |

### 5.5 扩展速查

**新增 Skill**：在 `skills/builtin/<skill_name>/` 下创建 `SKILL.md`，包含 `stage` 元数据；loader 自动发现。

**调整阶段上下文**：编辑 `config/stage_contexts.yaml` 中对应 `stages.<stage>`，修改 `prompt_template`、`skills` 等。

**新增平台规范**：在 `skills/builtin/platform_rules/` 下新增 `<platform>.md`，stage 为 `copy_write`。

---

## 6. 内置 Skills 示例

### 6.1 文案撰写 Skill（copy_writing）

- 内容：营销文案结构、标题技巧、CTA 规范、字数建议
- 阶段：copy_write

### 6.2 平台规范 Skill（platform_rules）

- 内容：小红书、微博、抖音的文案限制、话题格式、禁忌词
- 阶段：copy_write
- 可按平台拆分（xiaohongshu.md、weibo.md 等）

### 6.3 图片提示词 Skill（image_prompt）

- 内容：图片提示词结构、风格关键词、构图建议、负向提示词
- 阶段：image_prompt

---

## 7. FastAPI 接口设计

### 7.1 请求模型

```python
class GenerateRequest(BaseModel):
    requirements: str                    # 营销需求
    description: Optional[str] = None   # 详细描述
    platform: Optional[str] = None     # 平台
    style: Optional[str] = None        # 风格
    # 图片通过 multipart 单独上传；是否生成图像由 Agent 动态决策
```

### 7.2 响应模型

```python
class GenerateResponse(BaseModel):
    copy_text: str
    image_prompts: Optional[list[str]] = None
    generated_images: Optional[list[str]] = None  # Base64
    metadata: dict
```

### 7.3 并发与负载

- 使用 `asyncio` 处理请求
- 可选：`asyncio.Semaphore` 限制并发 LLM 调用
- 可选：长任务使用任务队列（Celery/RQ）；FastAPI 返回 task_id 供轮询

---

## 8. 配置管理

```python
# 环境变量（全部本地部署，无外部 API）
LLM_BASE_URL=http://localhost:8000/v1   # vLLM 等 OpenAI 兼容 API
LLM_MAIN_MODEL=Qwen/Qwen2.5-7B          # 主 LLM
LLM_ENHANCE_MODEL=...                   # 上下文增强 LLM（可与主模型相同）

# 图像生成（可选）
IMAGE_GEN_ENABLED=false
IMAGE_GEN_BASE_URL=...
IMAGE_GEN_MODEL=...

LOG_LEVEL=INFO
MAX_CONCURRENT_JOBS=10

# 安全校验（规则 + LLM 双重校验）
FORBIDDEN_WORDS_FILE=  # 违禁词文件路径
SAFETY_USE_LLM=true   # 是否使用 LLM 做合规校验
SAFETY_LLM_MODEL=     # 安全校验用 LLM，默认主模型

# 模块化扩展
SKILLS_DIRS=           # 额外 Skill 目录，逗号分隔
CONFIG_DIR=./config    # 配置目录（stage_contexts、prompts）
```

**vLLM 调用示例**（vLLM 暴露 OpenAI 兼容 API；Agent 通过 base_url 调用）：

```python
from langchain_openai import ChatOpenAI

# 主 LLM
llm = ChatOpenAI(
    base_url=os.environ["LLM_BASE_URL"],
    api_key="not-needed",  # 本地 vLLM 通常无需 key
    model=os.environ["LLM_MAIN_MODEL"],
)
```

---

## 9. 推荐目录结构

```
promotional-copy-generation/
├── config/                     # 模块化配置
│   ├── stage_contexts.yaml    # 阶段上下文配置
│   └── prompts/               # 阶段提示词模板
├── promotional_copy_generation/
│   ├── __init__.py
│   ├── api/
│   │   ├── routes.py
│   │   └── models.py
│   ├── agent/
│   │   ├── graph.py
│   │   ├── state.py
│   │   ├── multimodal.py      # 多模态消息构建
│   │   └── nodes/
│   │       ├── input_safety_checker.py
│   │       ├── output_safety_checker.py
│   │       ├── context_enhancer.py
│   │       ├── copy_writer.py
│   │       ├── image_prompt.py
│   │       └── image_generator.py
│   ├── safety/
│   │   └── checker.py
│   ├── skills/
│   │   ├── registry.py
│   │   ├── loader.py
│   │   └── builtin/
│   │       ├── copy_writing/
│   │       ├── platform_rules/
│   │       └── image_prompt/
│   ├── context/
│   │   └── stage_loader.py
│   └── config.py
├── docs/
├── pyproject.toml
└── README.md
```

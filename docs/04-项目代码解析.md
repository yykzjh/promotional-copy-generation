# 项目代码解析文档

本文档对 Promotional Copy Generation 项目进行代码级解析，包括功能模块概览、各模块职责、调用关系及启动方式。

---

## 一、项目总体概览

### 1.1 项目定位

本项目是一个基于 **LangGraph** 的营销文案生成 AI Agent，采用精简多模态流程：

- **上下文增强**：用户需求（文本+图像可选）→ 增强提示词
- **是否生成图像**：由 context_enhancer 在单次 LLM 调用中判断；有输入图通常出图，除非用户明确/暗示仅要纯文本
- **文案撰写**：增强提示词 → 推广文案
- **图像描述提示词**：需求（文本+图像可选）→ 图像提示词
- **图片生成**：图像提示词+输入图（可选）→ 配图（可配置启用）

### 1.2 技术栈

| 类别 | 技术 |
|------|------|
| 工作流编排 | LangGraph |
| LLM 调用 | LangChain + langchain-openai（兼容 vLLM 等 OpenAI API） |
| Web 服务 | FastAPI + Uvicorn |
| 配置管理 | Pydantic Settings + YAML |

### 1.3 目录结构

```
promotional_copy_generation/
├── __init__.py              # 包初始化
├── main.py                  # 应用入口（FastAPI + Uvicorn）
├── config.py                # 配置（环境变量）
├── api/                     # HTTP API 层
│   ├── routes.py            # 路由：/api/health, /api/generate
│   └── models.py            # 请求/响应模型
├── agent/                   # LangGraph Agent 核心
│   ├── graph.py             # 图定义与编排
│   ├── state.py             # AgentState 状态定义
│   ├── multimodal.py        # 多模态消息构建（文+图）
│   └── nodes/               # 图节点实现
│       ├── input_safety_checker.py
│       ├── output_safety_checker.py
│       ├── context_enhancer.py
│       ├── copy_writer.py
│       ├── image_prompt.py
│       └── image_generator.py
├── safety/                  # 安全校验
│   └── checker.py           # 输入/输出合规检查（规则 + LLM）
├── context/                 # 阶段上下文
│   └── stage_loader.py      # 加载阶段配置、提示词、Skills
└── skills/                  # Skills 模块化
    ├── registry.py          # Skill 注册与按阶段索引
    ├── loader.py            # 从 .md 文件加载 Skill
    └── builtin/             # 内置 Skills
        ├── copy_writing/
        ├── platform_rules/
        └── image_prompt/

config/                      # 项目配置（非包内）
├── stage_contexts.yaml     # 阶段配置
└── prompts/                 # 提示词模板
```

---

## 二、各模块功能解析

### 2.1 入口层：main.py

**职责**：应用启动入口，创建 FastAPI 应用并挂载路由。

- `create_app()`：创建 FastAPI 实例，注册 `/api` 路由
- `main()`：通过 Uvicorn 启动服务，默认 `0.0.0.0:8000`，开启 `reload`

### 2.2 配置层：config.py

**职责**：通过 Pydantic Settings 从 `.env` 加载配置。

| 配置项 | 说明 | 默认值 |
|--------|------|--------|
| `llm_base_url` | LLM API 地址（vLLM 等） | `http://localhost:8000/v1` |
| `llm_main_model` | 主模型名称 | `Qwen/Qwen2.5-7B` |
| `llm_enhance_model` | 上下文增强模型（可选） | 空，则用主模型 |
| `llm_vision_model` | 视觉模型（可选） | 空 |
| `image_gen_base_url` | 图像生成 API 地址（可选） | 同 llm_base_url |
| `image_gen_model` | 图像生成模型（可选） | 空 |
| `image_gen_enabled` | 是否启用图像生成 | false |
| `forbidden_words_file` | 违禁词文件路径 | 空 |
| `safety_use_llm` | 是否用 LLM 做合规检查 | `true` |
| `config_dir` | 配置目录 | `config` |
| `skills_dirs` | 额外 Skill 目录（逗号分隔） | 空 |

**属性**：`config_path`、`stage_contexts_path`、`mcp_servers_path`、`extra_skills_dirs` 等路径属性。

### 2.3 API 层：api/

#### routes.py

**职责**：定义 HTTP 接口，将请求转换为 Agent 输入并调用图。

- **启动时**：清空 Skill 注册表，从 `builtin` + `extra_skills_dirs` 加载 Skills
- **GET /api/health**：健康检查
- **POST /api/generate**：
  - 接收表单：`requirements`、`description`、`platform`、`style`、`images`
  - 是否生成图像由 Agent 动态决策（有图通常出图，除非用户明确/暗示仅要纯文本）
  - 构建 `AgentState` 初始状态，调用 `graph.invoke(initial_state)`
  - 处理安全拒绝、提取 `final_copy`、`image_prompts`、`generated_images`，返回 JSON

#### models.py

**职责**：定义请求/响应 Pydantic 模型（`GenerateRequest`、`GenerateResponse`）。

### 2.4 Agent 层：agent/

#### state.py

**职责**：定义 LangGraph 的 `AgentState`（TypedDict）。

- **输入**：`raw_requirements`、`raw_description`、`input_images`、`platform`、`style`、`has_input_images`
- **中间结果**：`enhanced_context`、`copy_draft`、`image_prompts`
- **输出**：`final_copy`、`generated_images`
- **控制**：`need_image_generation`（由 need_image_decision 节点设置）
- **安全**：`input_safety_passed`、`output_safety_passed`、`safety_reject_reason`

#### graph.py

**职责**：定义 LangGraph 工作流，编排各节点与条件边。

**节点**：`input_safety` → `context_enhance` → `copy_write` →（条件）`image_prompt` → `image_gen` → `output_safety` → END

**条件路由**：

- `_route_after_input_safety`：未通过则 `__reject__` → END
- `_route_after_copy`：`need_image_generation` 为真则走 `image_prompt`，否则直接 `output_safety`

#### nodes/ 各节点

| 节点 | 文件 | 功能 |
|------|------|------|
| `input_safety` | input_safety_checker.py | 调用 `safety.check_input` 检查需求与描述 |
| `output_safety` | output_safety_checker.py | 调用 `safety.check_output` 检查文案与图片提示词 |
| `context_enhancer` | context_enhancer.py | 文本+图像（可选）→ 增强提示词 + need_image_generation（单次 LLM） |
| `copy_writer` | copy_writer.py | 增强提示词 → 推广文案（结合平台规则、Skills） |
| `image_prompt` | image_prompt.py | 需求（文本+图像可选）→ 图像描述提示词（最多 3 条） |
| `image_generator` | image_generator.py | 图像提示词+输入图（可选）→ 配图（IMAGE_GEN_ENABLED 启用时） |

### 2.5 安全层：safety/checker.py

**职责**：输入/输出合规检查，规则 + LLM 双重校验。

- `_load_forbidden_words()`：从 `forbidden_words_file` 加载违禁词
- `_check_text_forbidden()`：规则检查，是否包含违禁词
- `_check_text_llm()`：LLM 检查，使用 `config/prompts/safety_check.txt` 或内置模板
- `check_input()`：检查 `requirements`、`description`（图片检查为占位）
- `check_output()`：检查 `copy`、`image_prompts`

### 2.6 上下文层：context/stage_loader.py

**职责**：按阶段加载配置、提示词、Skills。

- `get_stage_config(stage)`：从 `stage_contexts.yaml` 读取阶段配置
- `load_prompt_template(path)`：加载 `config/prompts/*.txt` 提示词
- `load_stage_context(stage, platform, style)`：返回 `{config, prompt_template, skills_content, skills, platform, style}`

**阶段**：`context_enhance`、`copy_write`、`image_prompt`

### 2.7 Skills 层：skills/

#### registry.py

**职责**：Skill 注册与按阶段索引。

- `Skill` 数据类：`id`、`name`、`stage`、`description`、`content`
- `register_skill()`、`get_skills_for_stage()`、`get_skill_by_id()`、`clear_registry()`
- 阶段：`context_enhance`、`image_analyze`、`ref_retrieve`、`copy_write`、`image_prompt`

#### loader.py

**职责**：从 Markdown 文件加载 Skill。

- 解析 YAML frontmatter（`id`、`name`、`stage`、`description`）
- `load_skill_from_file()`、`load_skills_from_dir()`、`load_skills_from_dirs()`
- 递归扫描目录，注册到 `registry`

### 2.8 多模态工具：agent/multimodal.py

**职责**：构建文+图混合输入，供各节点调用多模态 LLM。

- `build_multimodal_content(text, images)`：构建 `[{"type":"text",...}, {"type":"image_url",...}]` 格式
- `build_human_message(text, images)`：返回带可选图像的 `HumanMessage`

---

## 三、模块间调用关系

### 3.1 调用关系图

```
                    ┌─────────────┐
                    │   main.py   │
                    └──────┬──────┘
                           │ create_app
                           ▼
┌──────────────────────────────────────────────────────────────────┐
│                      api/routes.py                                 │
│  /api/health  /api/generate                                       │
│       │                                                            │
│       │  generate() ──► get_compiled_graph().invoke(initial_state)  │
│       │                     │                                      │
│       │                     │ 启动时: load_skills_from_dirs()      │
└───────┼─────────────────────┼────────────────────────────────────┘
        │                     │
        │                     ▼
        │              ┌──────────────┐
        │              │ agent/graph │
        │              │ StateGraph   │
        │              └──────┬───────┘
        │                     │
        │     ┌───────────────┼───────────────────────────┐
        │     │               │                           │
        │     ▼               ▼                           │
        │  input_safety   context_enhance                 │
        │     │               │                           │
        │     ▼               ▼                           │
        │  safety/        copy_write                      │
        │  checker            │                           │
        │     │               │                           │
        │     │     need_image? ──► image_prompt ──► image_gen
        │     │               │                           │
        │     └───────────────┴───────────────────────────┘
        │                     │
        │                     ▼
        │              output_safety ──► END
        │
        └─────────────────────────────────────
```

### 3.2 数据流

1. **API → Agent**：`routes.generate()` 构建 `AgentState`，调用 `graph.invoke()`
2. **Agent → 各节点**：每个节点接收 `state`，更新后返回新字段
3. **节点 → 支撑模块**：
   - `input_safety` / `output_safety` → `safety.checker`
   - `context_enhancer` / `copy_writer` / `image_prompt` → `context.stage_loader` → `skills.registry`
4. **配置**：`config.settings` 被 `safety`、`context`、各 LLM 节点共同使用

### 3.3 依赖关系汇总

| 模块 | 依赖 |
|------|------|
| main | api.routes, config |
| api.routes | agent.graph, agent.state, config, skills |
| agent.graph | agent.state, agent.nodes.* |
| agent.nodes.* | config, context, safety |
| context.stage_loader | config, skills |
| safety.checker | config |

---

## 四、项目启动方式

### 4.1 环境准备

1. **复制环境变量**：
   ```bash
   cp .env.example .env
   ```

2. **配置 `.env`**（必填）：
   - `LLM_BASE_URL`：vLLM 或兼容 OpenAI 的 API 地址
   - `LLM_MAIN_MODEL`：主模型名称

3. **可选配置**：
   - `LLM_ENHANCE_MODEL`、`LLM_VISION_MODEL`：增强/视觉模型
   - `FORBIDDEN_WORDS_FILE`：违禁词文件
   - `SAFETY_USE_LLM`：是否启用 LLM 合规检查
   - `SKILLS_DIRS`：额外 Skill 目录
   - `CONFIG_DIR`：配置目录（默认 `config`）

### 4.2 启动命令

```bash
# 安装依赖
uv sync

# 方式一：使用入口脚本（推荐）
uv run promotional-copy

# 方式二：直接使用 uvicorn
uv run uvicorn promotional_copy_generation.main:app --reload --host 0.0.0.0 --port 8000
```

### 4.3 服务地址

- 默认：`http://0.0.0.0:8000`
- 健康检查：`GET http://localhost:8000/api/health`
- 文案生成：`POST http://localhost:8000/api/generate`（multipart/form-data）

### 4.4 前置条件

- 需先部署 vLLM 或其他 OpenAI 兼容的 LLM 服务
- 若使用 MCP 参考检索，需在 `config/mcp_servers.yaml` 中启用并配置对应 MCP 服务

---

## 五、附录：配置文件说明

### stage_contexts.yaml

定义各阶段的提示词路径、Skills、MCP 工具等：

```yaml
stages:
  context_enhance:
    prompt_template: "prompts/context_enhance.txt"
    skills: []
  copy_write:
    prompt_template: "prompts/copy_write.txt"
    skills: ["copy_writing", "platform_rules"]
  # ...
```

### config/prompts/*.txt

各阶段提示词模板，支持占位符如 `{input}`、`{enhanced_context}`、`{platform_rules}`、`{image_descriptions}` 等。

---

## 六、多模态执行流

LLM 支持两种模式：文本+图像（可选）→ 文本；文本+图像（可选）→ 图像。

### 6.1 各节点模态

| 节点 | 模态 | 说明 |
|------|------|------|
| context_enhancer | 文本+图(可选)→文本 | 需求增强 + need_image 判断（单次 LLM） |
| copy_writer | 文本→文本 | 增强提示词→推广文案 |
| image_prompt | 文本+图(可选)→文本 | 需求→图像描述提示词 |
| image_generator | 文本+图(可选)→图像 | 提示词+图→配图 |

### 6.2 动态图像决策

- **有输入图**：通常 need_images = true，除非用户明确表示仅要纯文本或暗示不需要图像
- **无输入图**：由 LLM 根据需求判断

### 6.3 配置

| 变量 | 说明 | 默认 |
|------|------|------|
| IMAGE_GEN_BASE_URL | 图像生成 API 地址 | 同 LLM_BASE_URL |
| IMAGE_GEN_MODEL | 图像生成模型 | 同 LLM_VISION_MODEL 或 LLM_MAIN_MODEL |
| IMAGE_GEN_ENABLED | 是否启用图像生成 | false |

### 6.4 多模态消息格式

文本+图像输入采用 OpenAI 兼容格式，由 `agent/multimodal.py` 的 `build_human_message(text, images)` 统一构建。
